# nginx/nginx.conf - Version Corrigée pour Routage API vers Symfony (PHP-FPM)

server {
    listen 80;
    server_name localhost;

    # Définir le répertoire racine pour PHP (le dossier public de Symfony dans le conteneur)
    # C'est important pour le SCRIPT_FILENAME de FastCGI
    root /var/www/html/public;

    # 1. Gérer les requêtes pour l'API Symfony
    # Toutes les requêtes commençant par /api/ seront traitées par Symfony.
    location /api/ {
        # Réécrire l'URL pour retirer le préfixe /api/ et rediriger *internement* vers /index.php/<le reste du chemin>
        # Par exemple, /api/auth/register devient /index.php/auth/register pour Symfony
        rewrite ^/api/(.*)$ /index.php/$1 last;
    }

    # 2. Gérer les requêtes pour index.php (le point d'entrée de Symfony)
    # Cette section est interne, elle est utilisée par la réécriture ci-dessus.
    # Elle passe la requête au processus PHP-FPM.
    # nginx/nginx.conf (extrait du bloc location ~ ^/index\.php(/|$) )
    location ~ ^/index\.php(/|$) {
        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;

        # Paramètre crucial mis à jour
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        internal;
    }

    # 3. Gérer toutes les autres requêtes (pour le frontend Next.js)
    # Si une requête n'est pas une API ou ne correspond pas à index.php, elle est envoyée au serveur de dev Next.js.
    location / {
        proxy_pass http://frontend_dev:3000; # Proxy vers le serveur de développement Next.js
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}