# nginx/nginx.conf

server {
    listen 80;
    server_name localhost; # Utilise localhost pour le développement local

    # Configuration pour le backend Symfony (API)
    # Toutes les requêtes commençant par /api/ seront redirigées vers le conteneur PHP-FPM
    location /api/ {
        # Supprime le préfixe /api/ avant de passer à Symfony
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://php:9000; # 'php' est le nom du service PHP-FPM dans docker-compose
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Gérer les erreurs de fichiers non trouvés de Symfony
        try_files $uri /index.php$is_args$args;
    }

    # Configuration pour le frontend Next.js (en mode développement)
    # Toutes les autres requêtes (qui ne sont pas des API) sont redirigées vers le serveur de dev Next.js
    location / {
        proxy_pass http://frontend_dev:3000; # 'frontend_dev' est le nom du service Next.js dans docker-compose
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Optionnel: Pour servir les assets publics de Symfony si tu en as (ex: uploads, bundle assets)
    # location ~ ^/(bundles|uploads)/ {
    #     root /var/www/html/public; # Pointent vers le dossier public de Symfony dans le conteneur
    #     try_files $uri =404;
    # }
}